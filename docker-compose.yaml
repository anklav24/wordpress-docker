version: '2.4'

services:
  zabbix-agent:
    image: zabbix/zabbix-agent:ubuntu-5.0.16

    cpu_quota: 5000  # 1000 = 1%
    mem_reservation: 16M
    restart: always

    ports:
      - "10050:10050"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./zbx_env/etc/zabbix/zabbix_agentd.d:/etc/zabbix/zabbix_agentd.d:ro
      - ./zbx_env/var/lib/zabbix/modules:/var/lib/zabbix/modules:ro
      - ./zbx_env/var/lib/zabbix/enc:/var/lib/zabbix/enc:ro
      - ./zbx_env/var/lib/zabbix/ssh_keys:/var/lib/zabbix/ssh_keys:ro
    env_file:
      - ./deploy_configs/env_vars/zabbix_agent.env
    privileged: true
    pid: "host"
    stop_grace_period: 5s

  traefik:
    image: traefik:v2.5.3

    cpu_quota: 10000  # 1000 = 1%
    mem_reservation: 128M
    restart: always

    ports:
      - "80:80"
      - "443:443"
    volumes:
      - traefik-ssl-certs:/ssl-certs
      - ./deploy_configs/traefik/:/etc/traefik/
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - traefik.http.routers.dashboard.rule=Host(`traefik.oracle24.duckdns.org`)
      - traefik.http.routers.dashboard.tls.certresolver=staging
      - traefik.http.services.dashboard.loadbalancer.server.port=8080

      - traefik.enable=true
      - traefik.http.routers.dashboard.tls=true
      - traefik.http.routers.dashboard.entrypoints=http,https
      - traefik.http.routers.dashboard.middlewares=secheaders@file

      # Basic Authentication for Traefik Dashboard
      # Generate password: sudo apt update && sudo apt install apache2-utils && htpasswd -nb USER PASSWORD
      # You need to escape all $ sings ($ --> $$)
      - traefik.http.routers.dashboard.service=api@internal
      - traefik.http.routers.dashboard.middlewares=traefik-auth
      - traefik.http.middlewares.traefik-auth.basicauth.users=Oracle:$$apr1$$l5wr.jVu$$A/jaVwgCmnakAtZcp58IB1
    healthcheck:
      test: [ "CMD", "wget", "http://localhost:8082/ping","--spider" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    security_opt:
      - no-new-privileges:true
    networks:
      traefik_proxy_net:

  portainer: # optional more functional and creative UI for docker
    image: portainer/portainer-ce:2.9.1-alpine

    cpu_quota: 10000  # 1000 = 1%
    mem_reservation: 128M
    restart: always

    volumes:
      - portainer_data:/data
      - /var/run/docker.sock:/var/run/docker.sock  # Connect to docker API
    labels:
      - traefik.http.routers.portainer.rule=Host(`portainer.oracle24.duckdns.org`)
      - traefik.http.routers.portainer.tls.certresolver=production
      - traefik.http.services.portainer.loadbalancer.server.port=9000

      - traefik.enable=true
      - traefik.http.routers.portainer.entrypoints=http,https
      - traefik.http.routers.portainer.tls=true
    networks:
      traefik_proxy_net:

  4soulsband_wordpress:
    image: wordpress:php8.0

    cpu_quota: 10000  # 1000 = 1%
    mem_reservation: 256M
    restart: always

    depends_on:
      - 4soulsband_mysql_db
    env_file: ./deploy_configs/env_vars/4soulsband_wordpress.env
    volumes:
      - ./4soulsband_wordpress:/var/www/html
    labels:
      - traefik.http.routers.4soulsband_wordpress.rule=Host(`4soulsband.duckdns.org`)
      - traefik.http.routers.4soulsband_wordpress.tls.certresolver=staging
      - traefik.http.services.4soulsband_wordpress.loadbalancer.server.port=80

      - traefik.enable=true
      - traefik.http.routers.4soulsband_wordpress.entrypoints=http,https
      - traefik.http.routers.4soulsband_wordpress.tls=true
    networks:
      4soulsband_net:
      traefik_proxy_net:

  4soulsband_mysql_db:
    image: mysql/mysql-server:8.0

    cpu_quota: 10000  # 1000 = 1%
    mem_reservation: 512M
    restart: always

    ports:
      - "3316:3306"
    command: --default-authentication-plugin=mysql_native_password
    env_file: ./deploy_configs/env_vars/4soulsband_wordpress.env
    volumes:
      - ./4soulsband_mysql_db:/var/lib/mysql
    networks:
      4soulsband_net:

networks:
  traefik_proxy_net:
    driver: bridge
    driver_opts:
      com.docker.network.enable_ipv6: "false"
    ipam:
      driver: default
      config:
        - subnet: 172.16.250.0/24

  4soulsband_net:
    driver: bridge
    driver_opts:
      com.docker.network.enable_ipv6: "false"
    ipam:
      driver: default
      config:
        - subnet: 172.16.249.0/24

volumes: # Persistent data
  traefik-ssl-certs:
  portainer_data:
